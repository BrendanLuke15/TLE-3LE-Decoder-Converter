<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLE 2 CSV Utility</title>
    <meta name="description" content="Turn a .txt file of TLE or a text input to a CSV file">
    <meta name="author" content="Brendan Luke">
    <!--
        Date: July 6, 2021
    -->
</head>
<style>
button {
    font-size: 5vh;
    color: white;
    border-radius: 1vh;
    padding: 1.2vh 2vw;
    background-color: #0d5198;
    border: 0.4vh solid #444;
    transition-duration: 0.25s;
}
button:hover {
    color: #45900f;
    border-color: #45900f;
}
</style>
<body style="background-color: #444;">
    <div id="inputHouse" style="display: flex;">
        <div id="border1" style="display:flex; justify-content:center; align-items:center; width: 45vw; height: 35vh; background-color: #0d5198; margin-top: 31vh; margin-left: 3vw; border-radius: 3vw;">
            <div id="uploadButtonHouse" style="width: 42vw; height: 32vh; background-color: #eee; margin: none; border-radius: 3vw;">
                <button onclick="fileUpload()" style="width: 35vw; height: 25vh; margin-top: 3.5vh; margin-left: 3.5vw;">Upload TLE .txt File</button>
                <input type="file" id="fileInput" accept=".txt" style="display: none;"/> <!--  this element is hidden and activated by button click^ because it has limited styling -->
            </div>
        </div>
        <div id="border2" style="display:flex; justify-content:center; align-items:center; width: 45vw; height: 35vh; background-color: #0d5198; margin-top: 31vh; margin-left: 3vw; border-radius: 3vw;">
            <div id="uploadButtonHouse" style="width: 42vw; height: 32vh; background-color: #eee; margin: none; border-radius: 3vw;">
                <label for="input" style="font-family: Arial, Helvetica, sans-serif; position: relative; left: 5vw; top: 1vh; font-size: 2vh; line-height: normal; color: #0d5198;">Paste TLEs/3LEs here</label>
                <textarea id="textInput" name="input" style="width: 35vw; height: 25vh; margin-top: 1.5vh; margin-left: 3.5vw;"></textarea>
            </div>
        </div>
    </div>
    <div id="submitHouse">
        <button id="submitText" onclick="textSubmit()" style="position: relative; left: 30vw; width: 40vw; top: 5vh;">Submit Text Input</button>
    </div>
</body>
<script>
    // Read uploaded .txt file case:
    inputButton = document.getElementById('fileInput');
    inputButton.addEventListener('change',fileUpload); // add event listener for change in fileInput
    function fileUpload() {
        document.getElementById('fileInput').click();
        var file = this.files[0]; // get the first file
        var fileName = file.name; // filename of uploaded file
        var reader = new FileReader(); // create new file reader
        reader.readAsBinaryString(file); // required
        reader.onload = function(e) { // when file upload is completed do the following:
            let data = e.target.result; // data string 
            output(data,fileName);
        }
    }

    // Read submitted text case:
    function textSubmit() {
        var data = document.getElementById('textInput').value; // get contents of textInput element
        if (data === "") { // check if input is empty
            alert('Please submit data to the text input area.'); // alert user to input data
        } else {
            output(data,"Output TLEs.txt");
        }
    }

    // Output function
    function output(data,fileName) {
        data = data.split('\n'); // split data into array by new line
        var csvString = 'TLE:,Epoch:,Mean Motion:,Period (s):,Semi-Major Axis (m):,Eccentricity:,Inclination (deg):,Argument of Periapsis (deg):,Right Ascension of the Ascending Node (deg):,Apoapsis (km):,Periapsis (km):,Semi-Major Axis Height (km):\n'; // initialize final data holder
        //csvString = csvString + '"' + data[0] + '\n'; // add first line to output string
        for (let i = 0; i < data.length; i++) { // start from first line
            var lineNo = data[i].substring(0,1); // line number of TLE
            if (lineNo == '1') { // new TLE
                // get Epoch data:
                year = data[i].substring(18,20); // last two digits of year
                if (parseInt(year) < 57) {
                    year = parseInt('20'+year);
                } else {
                    year = parseInt('19'+year);
                }
                day = data[i].substring(20,31); // day of year
                /*
                            for now just pass the excel equation to the epoch data field
                */
                //day = addDays(new Date(year.toString()+'-01-01T00:00:00Z'),parseFloat(day));
                //console.log(day);
                Epoch = '=date(' + year + ',1,1)+' + (parseFloat(day)-1).toString(); // excel formula to find epoch

                // write data
                csvString = csvString + '"' + data[i] + '\n';
            } else { // second line of TLE
                csvString = csvString + data[i] + '\n'; // write TLE to string
                MM = data[i].substring(52,62); // mean motion (revs/day)
                T = 86400/parseFloat(MM); // orbital period (s)
                sma = Math.pow((Math.pow(T,2)*3.9860044188*Math.pow(10,14)/Math.pow((2*Math.PI),2)),(1/3)); // semi-major axis (m)
                ecc = '0.' + data[i].substring(26,32); // eccentricity
                inc = data[i].substring(8,15); // inclination (deg)
                weta = data[i].substring(34,41); // argument of periapsis (deg)
                RAAN = data[i].substring(17,24); // right ascension of the ascending node (deg)
                Apo = (sma*(1+parseFloat(ecc))-6378137)/1000; // apoapsis (km)
                Peri = (sma*(1-parseFloat(ecc))-6378137)/1000; // periapsis (km)
                smaH = (sma-6378137)/1000; // semi-major axis height (km) 

                // write data
                csvString = csvString + '","' + Epoch + '",' + MM + ',' + T + ',' + sma + ',' + ecc + ',' + inc + ',' + weta + ',' + RAAN + ',' + Apo + ',' + Peri + ',' + smaH + '\n';              
            }
        }
        // handle last entry:



        let blobFile = new Blob([csvString], {type: 'text/plain'}); // creates new blob data type from 'csvString' string variable
        // below creates file and downloads it to user's computer
        var a = document.createElement("a"),
        url = URL.createObjectURL(blobFile);
        a.href = url;
        a.download = fileName.substring(0,fileName.length-4) + ".csv";
        document.body.appendChild(a);
        a.click(); 
    }

    // function for dates
    function addDays(date, days) {
        var result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }
</script>
</html>